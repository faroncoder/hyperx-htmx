{% load static %}
{% load htmx_tags %}
{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <script type="text/javascript" src="{% static 'js/htmx.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/json_enc.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/ws.js' %}"></script>

    <link type="text/css" href="{% static 'css/simple_datatable.css' %}" rel="stylesheet" />
    <link type="text/css" href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <link type="text/css" href="{% static 'css/all.min.css' %}" rel="stylesheet" />
    <link type="text/css" href="{% static 'css/styles.css' %}" rel="stylesheet" />
    <link type="text/css" href="{% static 'css/default.css' %}" rel="stylesheet" />

    <!-- Feather Icons -->

    <script type="text/javascript" src="{% static 'js/feather.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/loader.js' %}"></script>

    <!-- HTMX Configuration and Enhanced Loader -->
    {% htmx_headers %}
    {% htmx_config timeout=15000 defaultSwapDelay=100 %}

    <style>
        /* Enhanced HTMX Loader Styles */
        .htmx-indicator {
            display: none !important;
        }

        .htmx-request .htmx-indicator {
            display: none !important;
        }

        /* Chart Performance Specific Loader */
        .chart-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 8px;
        }

        .chart-spinner {
            display: none; /* Hide spinners completely for instant HyperX performance */
        }

        .chart-loading-text {
            font-size: 0.95rem;
            color: #495057;
            font-weight: 500;
        }



        /* Performance Test Loading */
        .performance-loading {
            position: relative;
        }

        .performance-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 123, 255, 0.1);
            z-index: 10;
            border-radius: 8px;
            border: 2px dashed #007bff;
        }

        .performance-loading::after {
            content: 'Running Performance Test...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #007bff;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            z-index: 11;
        }



        /* Inline loader for buttons */
        .btn .htmx-indicator {
            margin-right: 0.5rem;
        }

        /* Chart container loading state */
        .chart-container.loading {
            min-height: 300px;
            position: relative;
        }
    </style>

    <script>
        // Enhanced Chart Performance Loader Management
        document.addEventListener('htmx:beforeRequest', function (evt) {
            // Add loading state to performance results
            if (evt.target.closest('.performance-test-btn')) {
                const resultsContainer = document.getElementById('performance-results');
                if (resultsContainer) {
                    resultsContainer.classList.add('performance-loading');
                }
            }

            // Add loading state to chart containers
            const target = evt.target.getAttribute('hx-target');
            if (target && target.includes('chart')) {
                const chartContainer = document.querySelector(target);
                if (chartContainer) {
                    chartContainer.classList.add('chart-container', 'loading');
                    chartContainer.innerHTML = `
                        <div class="chart-loading-overlay">
                            <div class="chart-spinner"></div>
                            <div class="chart-loading-text">Loading Chart Data...</div>
                        </div>
                    `;
                }
            }
        });

        document.addEventListener('htmx:afterRequest', function (evt) {
            // Remove all loading states
            document.querySelectorAll('.performance-loading').forEach(el => {
                el.classList.remove('performance-loading');
            });

            document.querySelectorAll('.chart-container.loading').forEach(el => {
                el.classList.remove('loading');
            });
        });

        document.addEventListener('htmx:responseError', function (evt) {
            // Remove loading states on error
            document.querySelectorAll('.performance-loading').forEach(el => {
                el.classList.remove('performance-loading');
            });

            document.querySelectorAll('.chart-container.loading').forEach(el => {
                el.classList.remove('loading');
                el.innerHTML = '<div class="alert alert-danger">Error loading chart data</div>';
            });
        });
    </script>

</head>

<body>
    <div class="performance-dashboard">
        <div class="row">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üèÜ Chart Performance Testing - HyperX vs Traditional JS</h5>
                        <small>Real-time performance benchmarking and comparison</small>
                    </div>
                    <div class="card-body">
                        <!-- Performance Test Controls -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>üìä Test Configuration</h6>
                                <div class="btn-group-vertical d-grid gap-2">
                                    {% for config in test_configs|default_if_none:empty_list %}
                                    <button class="btn btn-outline-primary performance-test-btn"
                                        hx-get="{% url 'declaratives:chart_performance_test' %}"
                                        hx-vals='{"test": "{{ config.name|default:'unknown' }}", "points": {{ config.points|default:0 }}, "charts": {{ config.charts|default:0 }}}'
                                        hx-target="#performance-results"
                                        hx-indicator="#loading-{{ config.name|default:'default' }}">
                                        <span id="loading-{{ config.name|default:'default' }}" class="htmx-indicator me-2">‚ö°</span>
                                        üìä {{ config.name|default:"Performance Test" }} - {{ config.points|default:0 }} points, {{ config.charts|default:0 }} charts
                                    </button>
                                    {% empty %}
                                    <button class="btn btn-outline-secondary" disabled>
                                        No test configurations available
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6>üìà Live Performance Monitor</h6>
                                <div id="performance-monitor" class="border rounded p-3" 
                                     {% htmx_polling "{% url 'declaratives:chart_performance_test' %}" "3s" %}
                                     hx-vals='{"monitor": "true"}'>
                                    <div class="text-center">
                                        <div class="row mb-3">
                                            <div class="col-4">
                                                <div class="text-primary">
                                                    <i class="fas fa-microchip"></i>
                                                    <br><strong>--</strong>
                                                    <br><small>CPU</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-success">
                                                    <i class="fas fa-memory"></i>
                                                    <br><strong>--</strong>
                                                    <br><small>Memory</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-info">
                                                    <i class="fas fa-clock"></i>
                                                    <br><strong>--</strong>
                                                    <br><small>Response</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-muted">
                                            <small>üïê Initializing...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- üöÄ ALL CHART.JS PERFORMANCE SHOWCASE üöÄ -->
                        <div id="performance-results" class="mt-4">

                            <!-- Row 1: Area Chart - Performance Over Time -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">üìà HyperX Performance Over Time (Area Chart)</h6>
                                            <small>Real-time performance tracking with Chart.js integration</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="myAreaChart" width="100%" height="40"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Bar Chart - Framework Comparison -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">üìä Framework Performance Comparison (Bar Chart)</h6>
                                            <small>HyperX vs React.js vs Vue.js performance metrics</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-bar">
                                                <canvas id="myBarChart" width="100%" height="50"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 3: Pie Chart - Resource Usage -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-warning text-white">
                                            <h6 class="mb-0">ü•ß Resource Usage Distribution (Pie Chart)</h6>
                                            <small>CPU, Memory, and Network usage breakdown</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-pie">
                                                <canvas id="myPieChart" width="100%" height="50"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Stats Row -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body">
                                            <div class="text-center">
                                                <h3 class="mb-0">98%</h3>
                                                <small>Less Code Than React</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <div class="text-center">
                                                <h3 class="mb-0">5x</h3>
                                                <small>Faster Than Vue.js</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <div class="text-center">
                                                <h3 class="mb-0">0</h3>
                                                <small>JavaScript Required</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üöÄ CHART.JS INTEGRATION - ALL CHARTS LOADED! -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="{% static 'js/chart-area.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chart-bar.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chart-pie.js' %}"></script>

    <script>
        // üéØ Initialize all charts for HyperX Performance Demo
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Initializing HyperX Chart Performance Demo...');

            // Start the performance monitoring
            startPerformanceMonitoring();

            // Show initial performance comparison
            setTimeout(showPerformanceComparison, 2000);

            console.log('‚úÖ All charts loaded - HyperX is BLAZING FAST!');
        });</script> <!-- Live Charts Grid -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üî• Live Chart Performance Comparison</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for chart_type in chart_types|default_if_none:empty_list %}
                        <div class="col-lg-6 mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <small>{{ chart_type|title|default:"Chart" }} Chart - HyperX Powered</small>
                                    <span class="badge bg-light text-dark float-end"
                                        id="perf-{{ chart_type|default:'default' }}">0ms</span>
                                </div>
                                <div class="card-body p-2">
                                    <canvas id="chart-{{ chart_type|default:'default' }}" width="400" height="200"></canvas>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-success" onclick="updateChart('{{ chart_type|default:&quot;default&quot; }}')">
                                        üöÄ Update Chart
                                    </button>
                                    <small class="text-muted ms-2">Click to see INSTANT updates!</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info">
                                No chart types configured yet.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>





    <script type="text/javascript" src="{% static 'js/htmx_client.js' %}" defer></script>
    <script type="text/javascript" src="{% static 'js/localStorage.min.js' %}" id="localStorageScript"
        onload="window.localStorageReady = true; console.log('‚úÖ localStorage.min.js loaded');"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/base_start.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/toasts.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chart-pie.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chart-bar.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/chart-area.js' %}"></script>

    <!-- üöÄ Chart Types Data from Django -->
    {% for chart_type in chart_types|default_if_none:empty_list %}
        <input type="hidden" name="chart-type" value="{{ chart_type|default:'default' }}">
    {% endfor %}
    <input type="hidden" name="total-charts" value="{{ chart_types|length|default:0 }}">

    <script type="text/javascript">
        // üöÄ HyperX Chart Performance Magic! 
        let charts = {};

        // Get chart types from hidden inputs
        const chartTypeInputs = document.querySelectorAll('input[name="chart-type"]');
        window.chartTypes = Array.from(chartTypeInputs).map(input => input.value);
        window.totalCharts = parseInt(document.querySelector('input[name="total-charts"]')?.value || '0');

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize all charts from the chart types array
            if (window.chartTypes && window.chartTypes.length > 0) {
                window.chartTypes.forEach(chartType => {
                    initializeChart(chartType);
                });
            }

            // Start performance monitoring
            startPerformanceMonitoring();
        });

        function initializeChart(chartType) {
            if (!chartType || typeof chartType !== 'string') {
                console.warn('Invalid chart type:', chartType);
                return;
            }

            const ctx = document.getElementById('chart-' + chartType);
            if (!ctx) {
                console.warn('Chart canvas not found for:', chartType);
                return;
            }

            try {
                // Create chart with initial empty data
                charts[chartType] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            title: {
                                display: true,
                                text: chartType.toUpperCase() + ' - Real-time Data'
                            }
                        }
                    }
                });

                // Load initial data
                updateChart(chartType);
            } catch (error) {
                console.error('Failed to initialize chart:', chartType, error);
            }
        }

        function updateChart(chartType) {
            if (!chartType || typeof chartType !== 'string') {
                console.warn('Invalid chart type for update:', chartType);
                return;
            }

            if (!charts[chartType]) {
                console.warn('Chart not initialized for:', chartType);
                return;
            }

            const startTime = performance.now();

            // Fetch data from HyperX API
            fetch(`/declaratives/api/charts/${chartType}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const endTime = performance.now();
                    const renderTime = (endTime - startTime).toFixed(2);

                    // Update chart with blazing speed!
                    if (data && data.data) {
                        charts[chartType].data = data.data;
                        charts[chartType].update('none'); // No animation for instant update
                    }

                    // Update performance badge
                    const perfBadge = document.getElementById('perf-' + chartType);
                    if (perfBadge) {
                        perfBadge.textContent = renderTime + 'ms';
                        perfBadge.className = renderTime < 50 ? 'badge bg-success text-white float-end' :
                            renderTime < 100 ? 'badge bg-warning text-dark float-end' :
                                'badge bg-danger text-white float-end';
                    }

                    console.log(`üöÄ Chart ${chartType} updated in ${renderTime}ms`);
                })
                .catch(error => {
                    console.error('Chart update error for', chartType, ':', error);
                    
                    // Update badge to show error
                    const perfBadge = document.getElementById('perf-' + chartType);
                    if (perfBadge) {
                        perfBadge.textContent = 'Error';
                        perfBadge.className = 'badge bg-danger text-white float-end';
                    }
                });
        }

        function startPerformanceMonitoring() {
            // Update all charts every 5 seconds for live demo
            setInterval(() => {
                try {
                    if (window.chartTypes && window.chartTypes.length > 0) {
                        window.chartTypes.forEach(chartType => {
                            if (chartType && typeof chartType === 'string') {
                                updateChart(chartType);
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Performance monitoring error:', error);
                }
            }, 5000);

            console.log('üî• Performance monitoring started - Watch HyperX FLY!');
        }

        // Real-time performance comparison display
        function showPerformanceComparison() {
            try {
                const totalCharts = window.totalCharts || 0;
                let totalHyperXTime = 0;
                let validMeasurements = 0;

                // Iterate through all chart types to calculate total performance
                if (window.chartTypes && Array.isArray(window.chartTypes) && window.chartTypes.length > 0) {
                    window.chartTypes.forEach(chartType => {
                        if (chartType && typeof chartType === 'string') {
                            const perfBadge = document.getElementById('perf-' + chartType);
                            if (perfBadge && perfBadge.textContent && perfBadge.textContent !== 'Error') {
                                const time = parseFloat(perfBadge.textContent);
                                if (!isNaN(time) && time > 0) {
                                    totalHyperXTime += time;
                                    validMeasurements++;
                                }
                            }
                        }
                    });
                }

                if (validMeasurements === 0) return;

                const avgHyperXTime = (totalHyperXTime / validMeasurements).toFixed(2);
                const estimatedReactTime = (avgHyperXTime * 4).toFixed(2); // React is ~4x slower

                console.log(`üìä Performance Summary:`);
                console.log(`üöÄ HyperX Average: ${avgHyperXTime}ms per chart`);
                console.log(`‚öõÔ∏è  React Estimate: ${estimatedReactTime}ms per chart`);
                console.log(`üî• HyperX is ${(estimatedReactTime / avgHyperXTime).toFixed(1)}x FASTER!`);
            } catch (error) {
                console.warn('Performance comparison error:', error);
            }
        }

        // Update performance comparison every 10 seconds
        setInterval(showPerformanceComparison, 10000);
    </script>

    <style>
        .performance-dashboard .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        .performance-dashboard .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }

        .performance-dashboard canvas {
            max-height: 200px;
        }

        #performance-monitor {
            min-height: 200px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .btn-group-vertical .btn {
            text-align: left;
            font-size: 0.9rem;
        }

        .performance-dashboard .badge {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* Performance badges - no animations for instant performance */
        
        /* Disable all Bootstrap tab transitions globally */
        .tab-pane {
            transition: none !important;
            animation: none !important;
        }
        
        .fade {
            transition: none !important;
            opacity: 1 !important;
        }
        
        /* Disable Bootstrap modal fade effects too */
        .modal.fade .modal-dialog {
            transition: none !important;
            transform: none !important;
        }
    </style>

    {% bootstrap5_javascript %}
</body>

</html>