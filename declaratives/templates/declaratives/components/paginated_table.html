{% load static %}
{% load htmx_tags %}
{% load django_bootstrap5 %} 
{% bootstrap_css %}
{% bootstrap_javascript %}
<!DOCTYPE html> 
<html lang="en">
    <head>
    <meta charset="UTF-8">
    
  <script type="text/javascript" src="{% static 'js/htmx.min.js' %}"></script>
  <script type ="text/javascript" src="{% static 'js/json_enc.js' %}"></script>
  <script type ="text/javascript" src="{% static 'js/ws.js' %}"></script>
  
  <link type="text/css" href="{% static 'css/simple_datatable.css' %}" rel="stylesheet" />
  <link type="text/css" href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
  <link type="text/css" href="{% static 'css/all.min.css' %}" rel="stylesheet" />
  <link type="text/css" href="{% static 'css/styles.css' %}" rel="stylesheet" />
  <link type="text/css" href="{% static 'css/default.css' %}" rel="stylesheet" />

    <!-- Feather Icons -->

      <script type ="text/javascript" src="{% static 'js/feather.min.js' %}"></script>
        <script type ="text/javascript" src="{% static 'js/loader.js' %}"></script>

</head>
<body>
<!-- Paginated Table Component -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">User Management Table</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" style="width: auto;"
                    {% htmx_get '/declaratives/component/table/data/' %}
                    {% htmx_trigger 'change' %}
                    hx-target="#table-container"
                    name="per_page">
                <option value="5" {% if per_page == 5 %}selected{% endif %}>5 per page</option>
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10 per page</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
            </select>
            
            <div class="input-group" style="width: 250px;">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Search users..."
                       {% htmx_get '/declaratives/component/table/data/' %}
                       {% htmx_trigger 'keyup changed delay:300ms' %}
                       hx-target="#table-container"
                       name="search"
                       value="{{ search_term }}">
                <button class="btn btn-outline-secondary btn-sm" type="button">
                    <i data-feather="search"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="table-container">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>
                            <a href="#" class="text-decoration-none"
                               {% htmx_get '/declaratives/component/table/data/' %}
                               hx-target="#table-container"
                               {% htmx_params 'sort=username&dir=' %}{% if sort_field == 'username' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}>
                                Username
                                {% if sort_field == 'username' %}
                                    <i data-feather="chevron-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="#" class="text-decoration-none"
                               {% htmx_get '/declaratives/component/table/data/' %}
                               hx-target="#table-container"
                               {% htmx_params 'sort=email&dir=' %}{% if sort_field == 'email' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}>
                                Email
                                {% if sort_field == 'email' %}
                                    <i data-feather="chevron-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="#" class="text-decoration-none"
                               {% htmx_get '/declaratives/component/table/data/' %}
                               hx-target="#table-container"
                               {% htmx_params 'sort=date_joined&dir=' %}{% if sort_field == 'date_joined' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}>
                                Joined
                                {% if sort_field == 'date_joined' %}
                                    <i data-feather="chevron-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>Status</th>
                        <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px;">
                                        <small class="text-white fw-bold">{{ user.username|slice:":1"|upper }}</small>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-medium">{{ user.username }}</div>
                                    <small class="text-muted">{{ user.get_full_name|default:"No name set" }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>{{ user.email }}</div>
                            {% if user.email_verified %}
                                <small class="text-success"><i data-feather="check-circle"></i> Verified</small>
                            {% else %}
                                <small class="text-warning"><i data-feather="alert-circle"></i> Unverified</small>
                            {% endif %}
                        </td>
                        <td>
                            <div>{{ user.date_joined|date:"M d, Y" }}</div>
                            <small class="text-muted">{{ user.date_joined|timesince }} ago</small>
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            {% if user.is_staff %}
                                <span class="badge bg-primary">Staff</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary"
                                        {% htmx_get '/declaratives/component/modal/content/' %}
                                        {% htmx_params 'type=user_edit&user_id=' %}{{ user.id }}
                                        hx-target="#modal-container"
                                        data-bs-toggle="modal" data-bs-target="#componentModal">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        {% htmx_delete_confirm "/declaratives/component/users/"|add:user.id|add:"/delete/" "closest tr" "Are you sure you want to delete user "|add:user.username|add:"?" %}>
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i data-feather="users" class="mb-2"></i>
                            <div>No users found</div>
                            {% if search_term %}
                                <small>Try adjusting your search criteria</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if users.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Table pagination">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Showing {{ users.start_index }}–{{ users.end_index }} of {{ users.paginator.count }} users
                    </small>
                    
                    <ul class="pagination pagination-sm mb-0">
                        {% if users.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="#"
                                   {% htmx_get '/declaratives/component/table/data/' %}
                                   hx-target="#table-container"
                                   {% htmx_params 'page=1' %}>First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#"
                                   {% htmx_get '/declaratives/component/table/data/' %}
                                   hx-target="#table-container"
                                   {% htmx_params 'page=' %}{{ users.previous_page_number }}>Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in users.paginator.page_range %}
                            {% if num == users.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="#"
                                       {% htmx_get '/declaratives/component/table/data/' %}
                                       hx-target="#table-container"
                                       {% htmx_params 'page=' %}{{ num }}>{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if users.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="#"
                                   {% htmx_get '/declaratives/component/table/data/' %}
                                   hx-target="#table-container"
                                   {% htmx_params 'page=' %}{{ users.next_page_number }}>Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#"
                                   {% htmx_get '/declaratives/component/table/data/' %}
                                   hx-target="#table-container"
                                   {% htmx_params 'page=' %}{{ users.paginator.num_pages }}>Last</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
        </div>
        {% endif %}
    </div>
</div>



  <script type="text/javascript" src="{% static 'js/htmx_client.js' %}" defer></script>
  <script type="text/javascript" src="{% static 'js/localStorage.min.js' %}" id="localStorageScript"
    onload="window.localStorageReady = true; console.log('✅ localStorage.min.js loaded');"></script>
  <script type="text/javascript" src="{% static 'js/bootstrap.bundle.min.js' %}"></script> 
  <script type="text/javascript" src="{% static 'js/base_start.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/toasts.js' %}"></script>









<script>
// Re-initialize Feather icons after HTMX swap
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'table-container') {
        feather.replace();
    }
});
</script>



{% bootstrap_javascript %}
</body>
</html>
